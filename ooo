-- Step 1: Create Test Database and Schema
CREATE DATABASE PRIVILEGE_COPY_TEST;
USE DATABASE PRIVILEGE_COPY_TEST;
CREATE SCHEMA TEST_SRC;

-- Step 2: Create Test Roles
CREATE ROLE TEST_ROLE_1;
CREATE ROLE TEST_ROLE_2;
GRANT ROLE TEST_ROLE_1 TO ROLE ACCOUNTADMIN;
GRANT ROLE TEST_ROLE_2 TO ROLE ACCOUNTADMIN;

-- Step 3: Create All Possible Objects in the Schema

-- A. Tables
CREATE TABLE TEST_SRC.MY_TABLE (id NUMBER);
GRANT SELECT ON TABLE TEST_SRC.MY_TABLE TO ROLE TEST_ROLE_1;
GRANT INSERT ON TABLE TEST_SRC.MY_TABLE TO ROLE TEST_ROLE_2;

-- B. Views
CREATE VIEW TEST_SRC.MY_VIEW AS SELECT * FROM TEST_SRC.MY_TABLE;
GRANT SELECT ON VIEW TEST_SRC.MY_VIEW TO ROLE TEST_ROLE_1;

-- C. Stages
CREATE STAGE TEST_SRC.MY_STAGE;
GRANT USAGE ON STAGE TEST_SRC.MY_STAGE TO ROLE TEST_ROLE_1;

-- D. File Formats
CREATE FILE FORMAT TEST_SRC.MY_FILE_FORMAT TYPE = CSV;
GRANT USAGE ON FILE FORMAT TEST_SRC.MY_FILE_FORMAT TO ROLE TEST_ROLE_1;

-- E. Sequences
CREATE SEQUENCE TEST_SRC.MY_SEQUENCE;
GRANT USAGE ON SEQUENCE TEST_SRC.MY_SEQUENCE TO ROLE TEST_ROLE_1;

-- F. Functions
CREATE FUNCTION TEST_SRC.MY_FUNCTION(num NUMBER)
RETURNS NUMBER
AS 'num + 1';
GRANT USAGE ON FUNCTION TEST_SRC.MY_FUNCTION(NUMBER) TO ROLE TEST_ROLE_1;

-- G. Procedures
CREATE PROCEDURE TEST_SRC.MY_PROCEDURE()
RETURNS STRING
LANGUAGE JAVASCRIPT
AS 'return "Hello, World!";';
GRANT USAGE ON PROCEDURE TEST_SRC.MY_PROCEDURE() TO ROLE TEST_ROLE_1;

-- H. Pipes
CREATE PIPE TEST_SRC.MY_PIPE AS COPY INTO TEST_SRC.MY_TABLE FROM @TEST_SRC.MY_STAGE;
GRANT USAGE ON PIPE TEST_SRC.MY_PIPE TO ROLE TEST_ROLE_1;

-- I. Streams
CREATE STREAM TEST_SRC.MY_STREAM ON TABLE TEST_SRC.MY_TABLE;
GRANT SELECT ON STREAM TEST_SRC.MY_STREAM TO ROLE TEST_ROLE_1;

-- J. Tasks
CREATE TASK TEST_SRC.MY_TASK
WAREHOUSE = COMPUTE_WH
SCHEDULE = '1 MINUTE'
AS
INSERT INTO TEST_SRC.MY_TABLE VALUES (1);
GRANT OWNERSHIP ON TASK TEST_SRC.MY_TASK TO ROLE TEST_ROLE_1;

-- Step 4: Grant Schema-Level Privileges
GRANT USAGE ON SCHEMA TEST_SRC TO ROLE TEST_ROLE_1;
GRANT MONITOR ON SCHEMA TEST_SRC TO ROLE TEST_ROLE_2;

-- Step 5: Grant Future Privileges
GRANT SELECT ON FUTURE TABLES IN SCHEMA TEST_SRC TO ROLE TEST_ROLE_1;
GRANT INSERT ON FUTURE TABLES IN SCHEMA TEST_SRC TO ROLE TEST_ROLE_2;