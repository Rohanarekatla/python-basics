#!/bin/bash

# Extract the primary account name and databases
PRIMARY_ACCOUNT=$(grep 'v_primaryaccount' terraform.tfvars | awk -F'=' '{print $2}' | tr -d ' "')
DATABASES=$(grep 'v_all_databases_for_failovergroup' terraform.tfvars | awk -F'=' '{print $2}' | tr -d '[]"' | tr ',' '\n' | tr -d ' ')

# ------------------------------------------------------------------------------
# Step 1: Initialize Terraform once (shared across all workspaces)
# ------------------------------------------------------------------------------
terraform init

# ------------------------------------------------------------------------------
# Step 2: Create account-level failover group in its own workspace
# ------------------------------------------------------------------------------
echo "Creating account-level failover group for account: $PRIMARY_ACCOUNT..."
terraform workspace new account-level || terraform workspace select account-level
terraform apply -auto-approve -target=snowflake_failover_group.source_failover_group -target=snowflake_failover_group.target_failover_group

# ------------------------------------------------------------------------------
# Step 3: Create database-level failover groups in isolated workspaces
# ------------------------------------------------------------------------------
for DB in $DATABASES; do
  echo "Creating failover group for database: $DB"
  terraform workspace new "$DB" || terraform workspace select "$DB"
  terraform apply -auto-approve -target=snowflake_failover_group.source_failover_database_group2[\"$DB\"] -target=snowflake_failover_group.target_failover_database_group2[\"$DB\"]
done

# Reset to default workspace (optional)
terraform workspace select default